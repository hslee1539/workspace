<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>{{ session.project_name }} - VS Code Web</title>
  <link rel="icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="32x32" href="/icon.png" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e2e8f0;
    }
    header {
      padding: 1.5rem 3rem;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    header .meta {
      display: flex;
      gap: 1.5rem;
      align-items: center;
      color: #94a3b8;
      font-size: 0.95rem;
    }
    header .actions {
      display: flex;
      gap: 0.75rem;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.6rem 1.4rem;
      border-radius: 999px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
    }
    .btn-secondary {
      background: rgba(148, 163, 184, 0.2);
      color: #e2e8f0;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(99, 102, 241, 0.3);
    }
    .status {
      padding: 0.35rem 1rem;
      border-radius: 999px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.8rem;
    }
    .status.pending { background: rgba(250, 204, 21, 0.15); color: #facc15; }
    .status.launching { background: rgba(56, 189, 248, 0.15); color: #38bdf8; }
    .status.running { background: rgba(16, 185, 129, 0.15); color: #34d399; }
    .status.error { background: rgba(248, 113, 113, 0.15); color: #f87171; }
    .status.stopped { background: rgba(148, 163, 184, 0.15); color: #cbd5f5; }
    .content {
      padding: 2rem 3rem;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 2rem;
    }
    .card {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 24px 48px rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(99, 102, 241, 0.2);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      margin-bottom: 1rem;
    }
    .info-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.75rem;
    }
    .info-list li {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      background: rgba(30, 41, 59, 0.6);
      padding: 0.9rem 1rem;
      border-radius: 12px;
    }
    .info-label {
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #94a3b8;
    }
    .info-value {
      font-size: 1rem;
      word-break: break-all;
    }
    iframe {
      width: 100%;
      height: calc(100vh - 140px);
      border: none;
      border-radius: 16px;
      background: #111827;
      box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.15);
    }
    .placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: calc(100vh - 140px);
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px dashed rgba(148, 163, 184, 0.4);
      color: #cbd5f5;
      font-size: 1rem;
      text-align: center;
      padding: 2rem;
    }
    .placeholder.error {
      border-color: rgba(248, 113, 113, 0.4);
      color: #fecaca;
    }
    .error-box {
      border: 1px solid rgba(248, 113, 113, 0.4);
      background: rgba(248, 113, 113, 0.1);
      color: #fecaca;
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>{{ session.project_name }}</h1>
      <div class="meta">
        <span id="session-status" class="status {{ session.status.value }}">{{ session.status.value }}</span>
        <span>포트 <span id="session-port">{{ session.port }}</span></span>
        <span>세션 ID {{ session.id }}</span>
      </div>
    </div>
    <div class="actions">
      <a class="btn btn-secondary" href="/">← 대시보드로</a>
      <form method="post" action="/sessions/{{ session.id }}/stop" style="margin:0;">
        <button type="submit" class="btn btn-secondary">세션 중지</button>
      </form>
      <a class="btn btn-primary" id="session-open-link" href="{{ session.access_url or '#' }}" target="_blank" rel="noopener"{% if not session.access_url %} style="display:none;"{% endif %}>새 창에서 열기</a>
    </div>
  </header>
  <div class="content">
    <aside class="card">
      <h2>세션 정보</h2>
      <ul class="info-list">
        <li>
          <span class="info-label">프로젝트 이름</span>
          <span class="info-value">{{ session.project_name }}</span>
        </li>
        <li>
          <span class="info-label">Git 저장소</span>
          <span class="info-value" id="session-git-url">{{ session.git_url or '지정되지 않음' }}</span>
        </li>
        <li>
          <span class="info-label">포트 / 접근 URL</span>
          <span class="info-value">
            <span id="session-port-detail">{{ session.port }}</span>
            <br />
            <a id="session-access-link" href="{{ session.access_url or '#' }}" style="color:#38bdf8;{% if not session.access_url %} display:none;{% endif %}" target="_blank" rel="noopener">{{ session.access_url or '' }}</a>
          </span>
        </li>
        <li>
          <span class="info-label">생성 시간</span>
          <span class="info-value">{{ session.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </li>
        <li>
          <span class="info-label">업데이트 시간</span>
          <span class="info-value" id="session-updated-at">{{ session.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
        </li>
      </ul>
      <div class="error-box" id="session-error-box"{% if not session.error_message %} style="display:none;"{% endif %}>
        <strong>오류:</strong>
        <div id="session-error-message">{{ session.error_message or '' }}</div>
      </div>
    </aside>
    <section>
      <iframe id="session-iframe" src="{% if session.status.value == 'running' and session.access_url %}{{ session.access_url }}{% endif %}"{% if session.status.value != 'running' or not session.access_url %} style="display:none;"{% endif %}></iframe>
      <div class="placeholder" id="session-placeholder"{% if session.status.value == 'running' and session.access_url %} style="display:none;"{% endif %}>컨테이너를 준비하는 중입니다. 잠시 후 자동으로 VS Code Web이 표시됩니다.</div>
      <div class="placeholder error" id="session-error-placeholder" style="display:none;">컨테이너를 시작하는 동안 오류가 발생했습니다. 오류 메시지를 확인하고 다시 시도하세요.</div>
    </section>
  </div>
  <script>
    (function() {
      const sessionId = "{{ session.id }}";
      const statusBadge = document.getElementById("session-status");
      const portBadge = document.getElementById("session-port");
      const portDetail = document.getElementById("session-port-detail");
      const accessLink = document.getElementById("session-access-link");
      const openLinkButton = document.getElementById("session-open-link");
      const iframe = document.getElementById("session-iframe");
      const placeholder = document.getElementById("session-placeholder");
      const errorPlaceholder = document.getElementById("session-error-placeholder");
      const updatedAt = document.getElementById("session-updated-at");
      const errorBox = document.getElementById("session-error-box");
      const errorMessage = document.getElementById("session-error-message");
      const gitUrl = document.getElementById("session-git-url");

      let polling = true;
      let iframeSrc = iframe.getAttribute("src");

      async function refreshStatus() {
        try {
          const response = await fetch(`/sessions/${sessionId}/status?ts=${Date.now()}`, { cache: "no-store" });
          if (!response.ok) {
            return;
          }
          const data = await response.json();
          const status = data.status || "pending";

          statusBadge.textContent = status;
          statusBadge.className = `status ${status}`;

          if (data.port) {
            portBadge.textContent = data.port;
            portDetail.textContent = data.port;
          }

          if (data.git_url !== undefined && gitUrl) {
            gitUrl.textContent = data.git_url || "지정되지 않음";
          }

          if (data.updated_at && updatedAt) {
            try {
              const localized = new Date(data.updated_at).toLocaleString("ko-KR");
              if (!Number.isNaN(Date.parse(data.updated_at))) {
                updatedAt.textContent = localized;
              }
            } catch (err) {
              // ignore formatting issues
            }
          }

          const hasError = Boolean(data.error_message);
          if (errorBox && errorMessage) {
            if (hasError) {
              errorBox.style.display = "block";
              errorMessage.textContent = data.error_message;
            } else {
              errorBox.style.display = "none";
              errorMessage.textContent = "";
            }
          }

          if (status === "running" && data.access_url) {
            if (placeholder) {
              placeholder.style.display = "none";
            }
            if (errorPlaceholder) {
              errorPlaceholder.style.display = "none";
            }
            if (iframe) {
              if (iframeSrc !== data.access_url) {
                iframeSrc = data.access_url;
                iframe.src = data.access_url;
              }
              iframe.style.display = "block";
            }
            if (accessLink) {
              accessLink.href = data.access_url;
              accessLink.textContent = data.access_url;
              accessLink.style.display = "inline";
            }
            if (openLinkButton) {
              openLinkButton.href = data.access_url;
              openLinkButton.style.display = "inline-flex";
            }
            polling = false;
          } else if (status === "error") {
            if (placeholder) {
              placeholder.style.display = "none";
            }
            if (iframe) {
              iframe.style.display = "none";
            }
            if (errorPlaceholder) {
              errorPlaceholder.style.display = "flex";
            }
            if (accessLink) {
              accessLink.style.display = "none";
              accessLink.textContent = "";
              accessLink.href = "#";
            }
            if (openLinkButton) {
              openLinkButton.style.display = "none";
              openLinkButton.href = "#";
            }
            polling = false;
          } else {
            if (placeholder) {
              placeholder.style.display = "flex";
            }
            if (iframe) {
              iframe.style.display = "none";
            }
            if (errorPlaceholder) {
              errorPlaceholder.style.display = "none";
            }
            if (accessLink) {
              accessLink.style.display = "none";
              accessLink.textContent = "";
              accessLink.href = "#";
            }
            if (openLinkButton) {
              openLinkButton.style.display = "none";
              openLinkButton.href = "#";
            }
          }
        } catch (error) {
          console.error("세션 상태를 갱신하지 못했습니다.", error);
        }
      }

      refreshStatus();
      const interval = setInterval(() => {
        if (!polling) {
          clearInterval(interval);
          return;
        }
        refreshStatus();
      }, 4000);
    })();
  </script>
</body>
</html>
